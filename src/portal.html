<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/portal.css">
        <link rel="stylesheet" href="css/manual.css">
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/bootstrap-grid.css">
        <script src="https://kit.fontawesome.com/1ada55961c.js" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link rel="icon" href="img/favicon.png">
        
        <title>Climate Futures Data Portal</title>

        <!-- Map Imports -->
            <!-- Import ArcGIS Map CSS -->
            <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css" />

            <!-- Import ArcGIS 4.15 Library. -->
            <script src="https://js.arcgis.com/4.15/"></script>

            <!-- Import Custom Map Setup Javascript. -->
            <script src="components/map.js"></script>
        <!-- End Map Imports -->

        <script>
            const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const FIRST_STEP = 1;
            const LAST_STEP = 3;

            var currentStep = 1;

            $(document).ready(function() {
                //Webpage starts on step 1 so hide step 2 and 3 and other irrelevant controls.
                $('#step2-options').hide();
                $('#step3-options').hide();

                $('#step2-content').hide();
                $('#step3-content').hide();

                $('#previous-step-button').hide();
                $('.download-button').hide();

                //User clicks a step.
                $('.step').click(function () {
                    //Get step number and select that step.
                    var id = $(this)[0].id;
                    currentStep = parseInt(id.charAt(id.length - 1));

                    selectStep(currentStep);
                });

                //User clicks "Previous Step" button.
                $('#previous-step-button').click(function() {
                    currentStep--;
                    selectStep(currentStep);
                });

                //User clicks "Next Step" button.
                $('#next-step-button').click(function() {
                    currentStep++;
                    selectStep(currentStep);
                });

                //Variables quick sort filter 
                $(".search-txt").keyup(function () {
                    var value = $(this).val().toLowerCase();

                    $('#variable-list > div').each(function () {
                        $(this).hide();

                        if ($(this).text().toLowerCase().indexOf($.trim(value)) >= 0) {
                            $(this).show();
                        }
                    })
                });

                $('.download-button').click(function() {
                    //This will eventually download data from backend code but for now it generates an example file and opens a save dialog.
                    var filename = "ExampleClimateDataFile.nc";
                    var text = "Data goes here.";

                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                    element.setAttribute('download', filename);

                    element.style.display = 'none';
                    document.body.appendChild(element);

                    element.click();

                    document.body.removeChild(element);
                });

                $('#map-rectangle-button').click(function() {
                    $('#mapDiv button.esri-icon-checkbox-unchecked').click();
                });

                $('#start-date').change(function() {
                    checkDatesValid();
                });

                $('#end-date').change(function() {
                    checkDatesValid();
                });

                /* Ajax use POST method for Download Function */
                $('.download-button').click(function () {
                    var area;
                    var variables = $('.variable:checked');
                    var stime = new Date($('input#start-date').val());
                    var etime = new Date($('input#end-date').val());
                    var ensemble_members = $('#step2-options select option:selected').text();

                    $.ajax({
                        url: 'des.jsp',
                        type: 'POST',
                        traditional: true,
                        data: {
                            area: area,
                            variables: variables,
                            stime: stime,
                            etime: etime,
                            ensemble_members: ensemble_members
                        },
                        success: function (data,status) {
                            alert(data + status);
                        },
                        error: function () {
                            alert("Something Wrong");
                        }
                    });
                });
            });

            function checkDatesValid() {
                var startDate = $('#start-date').val();
                var endDate = $('#end-date').val();

                if (startDate.length > 0 && endDate.length > 0) {
                    if (startDate > endDate) {
                        alert('Start date cannot come after end date!');
                    }
                }
            }

            function selectStep(stepInt) {
                if (stepInt >= FIRST_STEP && stepInt <= LAST_STEP) {
                    if (stepInt == LAST_STEP) {
                        updateSummaryPage();
                    }
                    
                    //Highlight selected step.
                    $('.step').removeClass('selected');
                    $('#step' + stepInt).addClass('selected');

                    //Hide all options and content.
                    $('.options').hide();
                    $('.content').hide();

                    //Show the selected options and content.
                    $('#step' + stepInt + '-options').show();
                    $('#step' + stepInt + '-content').show();

                    //Show/Hide "Previous Step" button.
                    if (stepInt == FIRST_STEP) 
                        $('#previous-step-button').hide();
                    else
                        $('#previous-step-button').show();

                    //Show/Hide "Next Step" and "Download" buttons.
                    if (stepInt == LAST_STEP) {
                        $('#next-step-button').hide();
                        $('.download-button').show();
                    }
                    else {
                        $('#next-step-button').show();
                        $('.download-button').hide();
                    }
                }
            }

            /* Update all fields on the summary page. */
            function updateSummaryPage() {
                updateSummaryPageEstimatedSize();
                updateSummaryPageLocation();
                updateSummaryPageTimePeriod();
                updateSummaryPageVariables();
            }

            /* Update the "Estimate Subset Size" field of the summary page. */
            function updateSummaryPageEstimatedSize() {
                //TODO.
                $('.summary-item#extract-size').text('500Mb (WIP)');
            }

            /* Update the "Selected Location/Area" field of the summary page. */
            function updateSummaryPageLocation() {
                //TODO.
                $('.summary-item#selected-area').text('Rectangle, 52.3ha (WIP)');
            }

            /* Update the "Selected Time Period" field of the summary page. */
            function updateSummaryPageTimePeriod() {
                var startDate = new Date($('input#start-date').val());
                var endDate = new Date($('input#end-date').val());

                if (isNaN(startDate)) {
                    $('.summary-item#start-date').addClass('error');
                    $('.summary-item#start-date').text('Not Selected!');
                }
                else {
                    $('.summary-item#start-date').removeClass('error');
                    $('.summary-item#start-date').text(`From ${ordinalSuffix(startDate.getDate())} of ${MONTH_NAMES[startDate.getMonth()]} ${startDate.getFullYear()}`);
                }

                if (isNaN(endDate)) {
                    $('.summary-item#end-date').addClass('error');
                    $('.summary-item#end-date').text('Not Selected!');
                }
                else {
                    $('.summary-item#end-date').removeClass('error');
                    $('.summary-item#end-date').text(`To ${ordinalSuffix(endDate.getDate())} of ${MONTH_NAMES[endDate.getMonth()]} ${endDate.getFullYear()}`);
                }

                //Check dates are in correct order (start before end).
                if (!isNaN(startDate) && !isNaN(endDate)) {
                    const NORMAL_TEXT = `Selected Time Period`;
                    const ERROR_TEXT = `Selected Time Period - ERROR: Start and End dates are in wrong order!`;

                    if (startDate > endDate) {
                        $('.summary-item#date-title').addClass('error');
                        $('.summary-item#date-title').text(ERROR_TEXT);
                    }
                    else {
                        $('.summary-item#date-title').removeClass('error');
                        $('.summary-item#date-title').text(NORMAL_TEXT);
                    }
                }
            }

            /* Update the "Selected Variables" field of the summary page. */
            function updateSummaryPageVariables() {
                $('.summary-item#selected-variables').empty();

                var selectedVariables = $('.variable:checked');

                if (selectedVariables.length == 0) {
                    $('.summary-item#selected-variables').append(`<li class="error">No Variables Selected!</li>`);
                }
                else {
                    selectedVariables.map(function(i, element) {
                        $('.summary-item#selected-variables').append(`
                            <li short-name="${element.getAttribute('short-name')}" long-name="${element.getAttribute('long-name')}">${element.getAttribute('long-name')}</li>
                        `);
                    });
                }
            }

            //Give a number and get it back with the ordinal suffix (st, nd, rd, or th).
            //Credit to Salman. A: https://stackoverflow.com/a/13627586/8306962
            function ordinalSuffix(i) {
                var j = i % 10,
                    k = i % 100;

                if (j == 1 && k != 11) {
                    return i + "st";
                }
                if (j == 2 && k != 12) {
                    return i + "nd";
                }
                if (j == 3 && k != 13) {
                    return i + "rd";
                }

                return i + "th";
            }
        </script>
    </head>
    <body>
        <div class="container-fluid content-stretcher">

            <!-- Header. Contains ClimateFutures logo and tagline. Hidden on sizes lower than lg. -->
            <div class="d-none d-lg-flex row content-stretcher-header justify-content-center" style="min-height: 106px">
                <a class="col-lg-5 col-xl-4 d-flex justify-content-center" href="https://climatefutures.org.au/" target="_blank">
                    <img alt="Climate Futures Logo" src="img/logo-small.png" style="margin-top: 34px; max-height:40px;" />
                </a>
                <div class="col-lg-5 col-xl-4" style="margin-top:26px;">
                    <div class="row d-flex justify-content-center">
                        <p class="tagline" style="margin-bottom: 5px;">Climate Science for Australia's Future</p>
                    </div>
                    <div class="row d-flex justify-content-center">
                        <img alt="INDRA Logo" src="img/indra-logo.png" style="max-width:28px; max-height:28px;">
                        <p class="tagline" style="font-size: 16px; margin: 5px 0 0 7px;">Powered by INDRA</p>
                    </div>
                </div>
            </div>
            <div class="row" id="steps">
                <a href="#" class="col-sm-12 col-md-3 step selected switch-btn" id="step1"><span>Area</span></a>
                <a href="#" class="col-sm-12 col-md-3 step switch-btn" id="step2"><span>Time & Variables</span></a>
                <a href="#" class="col-sm-12 col-md-3 step switch-btn" id="step3"><span>Download</span></a>
                <a href="manual.html" target="_blank" class="col-sm-12 col-md-3 step"><span><i class="fas fa-book" style="margin-right: 10px"></i>Manual</span></a>
            </div>
            <div class="row" id="options-container">
                <div class="row options" id="step1-options">
                    <div class="col-2 box align-self-start" style="min-width: 225px;">
                        <h4>Map Selection</h4>
                        <div id="map-controls">
                            
                        </div>
                    </div>
                    <a href="#" class="col-4 col-md-3 col-lg-2  align-self-end side-button-right align-self-end orange">Import Shapefile</a>
                </div>
                <div class="row options" id="step2-options">
                    <div class="col-6 col-md-5 box align-self-start" style="max-width: 375px; padding-right: 0px;">
                        <h4>Time Period</h4>
                        <div class="row" style="padding: 0">
                            <div class="col-6 flex-row">
                                <label style="padding: 0;margin: 0">Start Date</label>
                                <input type="date" id="start-date">
                            </div>
                            <div class="col-6 flex-row">
                                <label style="padding: 0;margin: 0">End Date</label>
                                <input type="date" id="end-date">
                            </div>
                        </div>
                    </div>
                    <div class="col-4 col-md-2 box align-self-start">
                        <h4>Time Resolution</h4>
                        <select style="position: absolute; bottom: 15px; width: calc(100% - 40px);">
                            <option>Hourly</option>
                            <option>Daily</option>
                            <option>Monthly</option>
                        </select>
                    </div>
<!--                    <div class="col-4 col-md-2 box align-self-start">-->
<!--                        <h4>Ensemble Member</h4>-->
<!--                        <select style="position: absolute; bottom: 15px; width: calc(100% - 40px);">-->
<!--                            <option>None</option>-->
<!--                            <option>Option 1</option>-->
<!--                            <option>Option 2</option>-->
<!--                            <option>Option 3</option>-->
<!--                            <option>Option 4</option>-->
<!--                            <option>Option 5</option>-->
<!--                            <option>Option 6</option>-->
<!--                        </select>-->
<!--                    </div>-->
                    <div class="col-12 col-md-2 align-self-end search-box">
                        <input class="search-txt" type="text" name="" placeholder="Search">
                        <span class="search-btn" href="#"></span>
                    </div>
                </div>
                <div class="row options" id="step3-options">
                    <!-- <div class="col-5 col-md-4 col-lg-3 box align-self-start">
                        <h4>Extraction Format</h4>
                        <select>
                            <option>NetCDF</option>
                        </select>
                    </div> -->
                    <div class="col-5 col-md-4 col-lg-3 box align-self-start">
                        <h4>Estimated Subset Size</h4>
                        <h6 class="summary-item" id="extract-size">500Mb</h6>
                    </div>
                </div>
            </div>
            <div class="row content-stretcher-content" id="content-container">
                <div class="content" id="step1-content" style="position: relative;">
                    <!-- Map Content -->
                    <!-- Div to hold map. -->
                    <div id="mapDiv" style="padding: 0; margin: 0; height: 100%; width: 100%;"></div>

                    <!-- Element to display mouse coordinates. -->
                    <p id="info" style="position:absolute; padding:2px 6px 2px 6px; background-color: #00000061; color:white; bottom:15px; right:15px;"></p>
                </div>
                <div class="content gap" id="step2-content">
                    <div class="row" class="variable-list" id="variable-list">
                        <!-- Generate variables dynamically, more scalable. -->
                        <script>
                            $(document).ready(function() {
                                //Variables in a 2d array, first is long name then short name.
                                var variables = [
                                    ["Air Temperature", "ta850"], //ta500, ta200
                                    ["Eastward Wind", "ua850"], //ua500, ua200
                                    ["Geopotential Height", "zg500"],  //zg200
                                    ["Northward Wind", "va850"], //va500, va200
                                    ["Near-Surface Air Temperature", "tas"], 
                                    ["Daily Max Near-Surface Air Temperature", "tasmax"], 
                                    ["Daily Min Near-Surface Air Temperature", "tasmin"], 
                                    ["Precipitation", "pr"], 
                                    ["Surface Air Pressure", "ps"], 
                                    ["Sea Level Pressure", "psl"], 
                                    ["Near-Surface Specific Humidity", "huss"], 
                                    ["Near-Surface Relative Humidity", "hurs"], 
                                    ["Near-Surface Wind Speed", "sfcWind"], 
                                    ["Daily Max Near-Surface Wind Speed", "sfcWindmax"], 
                                    ["Total Cloud Fraction", "clt"], 
                                    ["Duration of Sunshine", "sund"], 
                                    ["Surface Downwelling Shortwave Radiation", "rsds"], 
                                    ["Surface Downwelling Longwave Radiation", "rlds"], 
                                    ["Surface Upward Latent Heat Flux", "hfls"], 
                                    ["Surface Upward Sensible Heat Flux", "hfss"], 
                                    ["Surface Upwelling Shortwave Radiation", "rsus"], 
                                    ["Surface Upwelling Longwave Radiation", "rlus"], 
                                    ["Evaporation", "evspsbl"], 
                                    ["Potential Evapotranspiration", "evspsblpot"], 
                                    ["Soil Frozen Water Content", "mrfso"], 
                                    ["Surface Runoff", "mrros"], 
                                    ["Total Runoff", "mrro"], 
                                    ["Total Soil Moisture Content", "mrso"], 
                                    ["Surface Snow Amount", "snw"], 
                                    ["Surface Snow Melt", "snm"], 
                                    ["Daily Max Hourly Precipitation Rate", "prhmax"], 
                                    ["Convective Precipitation", "prc"], 
                                    ["TOA Outgoing Longwave Radiation", "rlut"], 
                                    ["TOA Incident Shortwave Radiation", "rsdt"], 
                                    ["TOA Outgoing Shortwave Radiation", "rsut"], 
                                    ["Eastward Near-Surface Wind", "uas"], 
                                    ["Northward Near-Surface Wind", "vas"], 
                                    ["Daily Max Near-Surface Wind Speed of Gust", "wsgsmax"], 
                                    ["Surface Downward Eastward Wind Stress", "tauu"], 
                                    ["Surface Downward Northward Wind Stress", "tauv"], 
                                    ["Surface Temperature", "ts"], 
                                    ["Height of Boundary Layer", "zmla"], 
                                    ["Water Vapor Path", "prw"], 
                                    ["Condensed Water Path", "clwvi"], 
                                    ["Ice Water Path", "clivi"], 
                                    ["Specific Humidity", "hus850"],  
                                    ["High Level Cloud Fraction", "clh"], 
                                    ["Mid Level Cloud Fraction", "clm"], 
                                    ["Low Level Cloud Fraction", "cll"], 
                                    ["Snow Area Fraction", "snc"], 
                                    ["Snow Depth", "snd"], 
                                    ["Sea Ice Area Fraction", "sic"], 
                                    ["Snowfall Flux", "prsn"], 
                                    ["Atmosphere Grid-Cell Area", "areacella"], 
                                    ["Surface Altitude", "orog"], 
                                    ["Land Area Fraction", "sftlf"], 
                                    ["Fraction of Grid Cell Covered with Glacier", "sftgif"], 
                                    ["Capacity of Soil to Store Water", "mrsofc"], 
                                    ["Max Root Depth", "rootd"], 
                                ];

                                variables = variables.sort(function (x,y) {
                                    return x[0].localeCompare(y[0]);
                                })

                                for(var i = 0; i < variables.length; i++)
                                {
                                    $('#variable-list').append(`
                                        <div class="col-12 col-md-6 col-xl-4">
                                            <div class="result">
                                                <input id="${variables[i][0]}" class="variable" type="checkbox" short-name="${variables[i][1]}" long-name="${variables[i][0]}">
                                                <label for="${variables[i][0]}">${variables[i][0]}</label>
                                            </div>
                                        </div>
                                    `);
                                }
                            });
                        </script>
                    </div>
                </div>
                <div class="content gap" id="step3-content">
                    <h2>Selection Summary</h2>

                    <h4>Selected Area</h4>
                    <label class="summary-item" id="selected-area">Rectangle, 52.3ha</label>

                    <h4 class="summary-item" id="date-title">Selected Time Period</h4>
                    <label class="summary-item" id="start-date">Start Date: 01-May-2020</label>
                    <br/>
                    <label class="summary-item" id="end-date">End Date: 06-May-2020</label>
                    <br/>

                    <h4>Selected Variables</h4>
                    <ul class="summary-item" id="selected-variables">
                        <li>Tempurature</li>
                        <li>Wind Speed</li>
                    </ul>

                    <!-- Download button for when footer is hidden. Only shown on sizes lower than lg. -->
                    <a href="#" class="download-button d-block d-lg-none blue button" style="max-width: 225px">Download</a>
                </div>
            </div>

            <!-- Footer with buttons. Hidden on sizes lower than lg. -->
            <div class="d-none d-lg-flex row content-stretcher-footer bg-dark-blue" style="min-height: 100px !important;">
                <a href="#" id="previous-step-button" class="col-2 align-self-end side-button-left align-self-end blue">Previous Step</a>
                <a href="#" id="next-step-button" class="col-2 align-self-end side-button-right align-self-end blue">Next Step</a>
                <a href="#" class="download-button col-2 align-self-end side-button-right align-self-end blue switch-btn">Download</a>
            </div>

            <!-- Small Privacy Policy Button -->
            <div class="row d-flex justify-content-center">
                <div class="col-12 d-flex justify-content-center">
                    <a href="privacy.html" style="font-size: 12px; position: absolute; bottom: 0px; text-align: center; color: #e2e2e2;">Privacy Policy</a>
                </div>
            </div>
        </div>
    </body>
</html>