<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/portal.css">
        <link rel="stylesheet" href="css/manual.css">
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/bootstrap-grid.css">
        <script src="https://kit.fontawesome.com/1ada55961c.js" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link rel="icon" href="img/favicon.png">

        <!-- Map Imports -->
            <!-- Import ArcGIS Map CSS -->
            <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css" />

            <!-- Import ArcGIS 4.15 Library. -->
            <script src="https://js.arcgis.com/4.15/"></script>

            <!-- Import Custom Map Setup Javascript. -->
            <script src="components/map.js"></script>
        <!-- End Map Imports -->

        <script>
            const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const FIRST_STEP = 1;
            const LAST_STEP = 3;

            var currentStep = 1;

            $(document).ready(function() {
                //Webpage starts on step 1 so hide step 2 and 3 and other irrelevant controls.
                $('#step2-options').hide();
                $('#step3-options').hide();

                $('#step2-content').hide();
                $('#step3-content').hide();

                $('#previous-step-button').hide();
                $('#download-button').hide();

                //User clicks a step.
                $('.step').click(function () {
                    //Get step number and select that step.
                    var id = $(this)[0].id;
                    currentStep = parseInt(id.charAt(id.length - 1));

                    selectStep(currentStep);
                });

                //User clicks "Previous Step" button.
                $('#previous-step-button').click(function() {
                    currentStep--;
                    selectStep(currentStep);
                });

                //User clicks "Next Step" button.
                $('#next-step-button').click(function() {
                    currentStep++;
                    selectStep(currentStep);
                });

                //Variables quick sort filter 
                $(".search-txt").keyup(function () {
                    var value = $(this).val().toLowerCase();

                    $('.variable-list div').each(function () {
                        $(this).hide();

                        if ($(this).text().toLowerCase().indexOf($.trim(value)) >= 0) {
                            $(this).show();
                        }
                    })
                });

                $('#download-button').click(function() {
                    //This will eventually download data from backend code but for now it generates an example file and opens a save dialog.
                    var filename = "ExampleClimateDataFile.nc";
                    var text = "Data goes here.";

                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                    element.setAttribute('download', filename);

                    element.style.display = 'none';
                    document.body.appendChild(element);

                    element.click();

                    document.body.removeChild(element);
                });

                $('#map-rectangle-button').click(function() {
                    $('#mapDiv button.esri-icon-checkbox-unchecked').click();
                });
            });

            function selectStep(stepInt) {
                if (stepInt >= FIRST_STEP && stepInt <= LAST_STEP) {
                    if (stepInt == LAST_STEP) {
                        updateSummaryPage();
                    }
                    
                    //Highlight selected step.
                    $('.step').removeClass('selected');
                    $('#step' + stepInt).addClass('selected');

                    //Hide all options and content.
                    $('.options').hide();
                    $('.content').hide();

                    //Show the selected options and content.
                    $('#step' + stepInt + '-options').show();
                    $('#step' + stepInt + '-content').show();

                    //Show/Hide "Previous Step" button.
                    if (stepInt == FIRST_STEP) 
                        $('#previous-step-button').hide();
                    else
                        $('#previous-step-button').show();

                    //Show/Hide "Next Step" and "Download" buttons.
                    if (stepInt == LAST_STEP) {
                        $('#next-step-button').hide();
                        $('#download-button').show();
                    }
                    else {
                        $('#next-step-button').show();
                        $('#download-button').hide();
                    }
                }
            }

            /* Update all fields on the summary page. */
            function updateSummaryPage() {
                updateSummaryPageEstimatedSize();
                updateSummaryPageLocation();
                updateSummaryPageTimePeriod();
                updateSummaryPageVariables();
            }

            /* Update the "Estimate Subset Size" field of the summary page. */
            function updateSummaryPageEstimatedSize() {
                //TODO.
                $('.summary-item#extract-size').text('500Mb (WIP)');
            }

            /* Update the "Selected Location/Area" field of the summary page. */
            function updateSummaryPageLocation() {
                //TODO.
                $('.summary-item#selected-area').text('Rectangle, 52.3ha (WIP)');
            }

            /* Update the "Selected Time Period" field of the summary page. */
            function updateSummaryPageTimePeriod() {
                var startDate = new Date($('input#start-date').val());
                var endDate = new Date($('input#end-date').val());

                if (isNaN(startDate)) {
                    $('.summary-item#start-date').addClass('error');
                    $('.summary-item#start-date').text('Not Selected!');
                }
                else {
                    $('.summary-item#start-date').removeClass('error');
                    $('.summary-item#start-date').text(`From ${ordinalSuffix(startDate.getDate())} of ${MONTH_NAMES[startDate.getMonth()]} ${startDate.getFullYear()}`);
                }

                if (isNaN(endDate)) {
                    $('.summary-item#end-date').addClass('error');
                    $('.summary-item#end-date').text('Not Selected!');
                }
                else {
                    $('.summary-item#end-date').removeClass('error');
                    $('.summary-item#end-date').text(`To ${ordinalSuffix(endDate.getDate())} of ${MONTH_NAMES[endDate.getMonth()]} ${endDate.getFullYear()}`);
                }
            }

            /* Update the "Selected Variables" field of the summary page. */
            function updateSummaryPageVariables() {
                $('.summary-item#selected-variables').empty();

                var selectedVariables = $('.variable:checked');

                if (selectedVariables.length == 0) {
                    $('.summary-item#selected-variables').append(`<li class="error">No Variables Selected!</li>`);
                }
                else {
                    selectedVariables.map(function(i, element) {
                        $('.summary-item#selected-variables').append(`
                            <li short-name="${element.getAttribute('short-name')}" long-name="${element.getAttribute('long-name')}">${element.getAttribute('long-name')}</li>
                        `);
                    });
                }
            }

            //Give a number and get it back with the ordinal suffix (st, nd, rd, or th).
            //Credit to Salman. A: https://stackoverflow.com/a/13627586/8306962
            function ordinalSuffix(i) {
                var j = i % 10,
                    k = i % 100;

                if (j == 1 && k != 11) {
                    return i + "st";
                }
                if (j == 2 && k != 12) {
                    return i + "nd";
                }
                if (j == 3 && k != 13) {
                    return i + "rd";
                }

                return i + "th";
            }
        </script>
    </head>
    <body>
        <div class="container-fluid content-stretcher">
            <div class="row content-stretcher-header justify-content-center" style="min-height: 106px">
                <div class="col-md-3">
                    <img alt="Climate Futures Logo" src="img/logo-small.png" style="margin-top: 30px;" />
                </div>
                <div class="col-md-3">
                    <main>
                        <p class="tagline">
                            Climate Science for Australia's Future
                        </p>
                    </main>
                </div>
            </div>
            <div class="row" id="steps">
                <a href="#" class="col-sm-12 col-md-3 step selected switch-btn" id="step1">Area</a>
                <a href="#" class="col-sm-12 col-md-3 step switch-btn" id="step2">Time and Variables</a>
                <a href="#" class="col-sm-12 col-md-3 step switch-btn" id="step3">Download</a>
                <a href="manual.html" target="_blank" class="col-sm-12 col-md-3 step"><i class="fas fa-book" style="margin-right: 10px"></i>Manual</a>
            </div>
            <div class="row" id="options-container">
                <div class="row options" id="step1-options">
                    <div class="col-2 box align-self-start">
                        <h4>Map Selection</h4>
                        <div id="map-controls">
                            
                        </div>
                    </div>
                    <a href="#" class="col-2 align-self-end side-button-right align-self-end orange">Import Shapefile</a>
                </div>
                <div class="row options" id="step2-options">
                    <div class="col-3 box align-self-start" >
                        <h4>Time Period</h4>
                        <div class="row" style="padding: 0">
                            <div class="col-6 flex-row">
                                <label style="padding: 0;margin: 0">Start Date</label>
                                <input type="date" id="start-date">
                            </div>
                            <div class="col-6 flex-row">
                                <label style="padding: 0;margin: 0">End Date</label>
                                <input type="date" id="end-date">
                            </div>
                        </div>
                    </div>
                    <div class="col-2 box align-self-start">
                        <h4>Ensemble Member</h4>
                        <select>
                            <option>Option 1</option>
                            <option>Option 2</option>
                        </select>
                    </div>
                    <div class="col-2 align-self-end search-box">
                        <input class="search-txt" type="text" name="" placeholder="Search Variables">
                        <a class="search-btn" href="#"></a>
                    </div>
                </div>
                <div class="row options" id="step3-options">
                    <div class="col-2 box align-self-start">
                        <h4>Extraction Format</h4>
                        <select>
                            <option>NetCDF</option>
                            <option>CSV</option>
                            <option>Excel</option>
                        </select>
                    </div>
                    <div class="col-2 box align-self-start">
                        <h4>Estimated Subset Size</h4>
                        <h6 class="summary-item" id="extract-size">500Mb</h6>
                    </div>
                </div>
            </div>
            <div class="row content-stretcher-content" id="content-container">
                <div class="content" id="step1-content" style="position: relative;">
                    <!-- Map Content -->
                    <!-- Div to hold map. -->
                    <div id="mapDiv" style="padding: 0; margin: 0; height: 100%; width: 100%;"></div>

                    <!-- Element to display mouse coordinates. -->
                    <p id="info" style="position:absolute; padding:2px 6px 2px 6px; background-color: #00000061; color:white; bottom:15px; right:15px;"></p>
                </div>
                <div class="content gap" id="step2-content">
                    <form class="variable-list" id="variable-list">
                        <!-- Generate variables dynamically, more scalable. -->
                        <script>
                            $(document).ready(function() {
                                //Variables in a 2d array, first is long name then short name.
                                var variables = [
                                    ["Humidity", "hmd"],
                                    ["Temperature", "tmp"],
                                    ["Wind Direction", "wdir"]
                                ];

                                for(var i = 0; i < variables.length; i++)
                                {
                                    $('#variable-list').append(`
                                        <div>
                                            <label>${variables[i][0]}</label>
                                            <input class="variable" type="checkbox" short-name="${variables[i][1]}" long-name="${variables[i][0]}">
                                        </div>
                                    `);
                                }
                            });
                        </script>
                    </form>
                </div>
                <div class="content gap" id="step3-content">
                    <h2>Selection Summary</h2>

                    <h4>Selected Area</h4>
                    <label class="summary-item" id="selected-area">Rectangle, 52.3ha</label>

                    <h4>Selected Time Period</h4>
                    <label class="summary-item" id="start-date">Start Date: 01-May-2020</label>
                    <br/>
                    <label class="summary-item" id="end-date">End Date: 06-May-2020</label>
                    <br/>

                    <h4>Selected Variables</h4>
                    <ul class="summary-item" id="selected-variables">
                        <li>Tempurature</li>
                        <li>Wind Speed</li>
                    </ul>
                </div>
            </div>
            <div class="row content-stretcher-footer bg-dark-blue" style="min-height: 100px !important;">
                <a href="#" id="previous-step-button" class="col-2 align-self-end side-button-left align-self-end blue">Previous Step</a>
                <a href="#" id="next-step-button" class="col-2 align-self-end side-button-right align-self-end blue">Next Step</a>
                <a href="#" id="download-button" class="col-2 align-self-end side-button-right align-self-end blue switch-btn">Download</a>
            </div>
        </div>
    </body>
</html>